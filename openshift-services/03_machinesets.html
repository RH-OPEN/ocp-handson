<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MachineSets, Machines, Nodes :: OpenShift Handson</title>
    <link rel="canonical" href="https://rh-open.github.io/ocp-handson/openshift-services/03_machinesets.html">
    <link rel="prev" href="02_app-storage-basics.html">
    <link rel="next" href="04_infra-nodes.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://rh-open.github.io/ocp-handson">OpenShift Handson</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="openshift-services" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">01. [WIP]OpenShift 基礎</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01_app-mgmt-basics.html">1. コンテナデプロイと管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02_app-storage-basics.html">2. 永続ストレージ</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="03_machinesets.html">3. ノードの動的管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04_infra-nodes.html">4. Infra ノードの作成</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05_ldap-groupsync.html">5. 外部認証プロバイダ設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06_template-quota-limits.html">6. プロジェクトのクオータ設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07_clusterresourcequota.html">7. クラスタのクオータ設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08_disabling-project-self-provisioning.html">8. Project セルフプロビジョニング</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09_networking.html">9. Network Policy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10_taints-and-tolerations.html">10. Taint/Toleration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">- - -</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">10. [WIP]OpenShift Logging</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">11. [WIP]OpenShift Monitoring</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">- - -</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">20. OpenShift Pipeline Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-pipeline-install.html">インストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-pipelines.html">1. Pipelines -1/2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-add-task.html">2. Pipelines -2/2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-triggers.html">3. Tekton Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">21. OpenShift GitOps Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20-GitOps-install.html">インストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="21-GitOps.html">1. OpenShift GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="22-Kustomize.html">2. Kustomizeインテグレーション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="23-Helm.html">3. Helmインテグレーション</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">- - -</span>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">70. [WIP]OpenShift Data Foundation</span>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">71. [WIP]Advanced Cluster Management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32_Deploying_And_Importing_Clusters_Lab.html">1. Cluster Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33_Pooling_And_Organizing_Clusters_Lab.html">2. Cluster management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="34_Application_Lab.html">3. App Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="35_PoolSet_Optional_And_Cleanup.html">4. PoolSet</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Handson</a></li>
    <li>01. [WIP]OpenShift 基礎</li>
    <li><a href="03_machinesets.html">3. ノードの動的管理</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RH-OPEN/ocp-handson/edit/master/documentation/modules/ROOT/pages/03_machinesets.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">MachineSets, Machines, Nodes</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>本コンテンツは、<a href="https://github.com/team-ohc-jp-place/openshift-cns-testdrive">MAD Workshop Ops Track</a> の内容を利用しています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_演習の概要"><a class="anchor" href="#_演習の概要"></a>演習の概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes <code>Node</code> はコンテナがオーケストレーションされ、<code>Pod</code> として実行される場所です。OpenShift 4は、<code>Operator</code> を使った自動化に重点を置いている点で、OpenShift 3とは根本的に異なります。<code>Node</code> に関しては、<code>Node</code> の作成と破壊を含め、クラスタサイズの状態を維持することに重点を置いた <code>Operator</code> とコントローラのセットがあります。</p>
</div>
<div class="paragraph">
<p>この演習では、クラスタサイズを保つために利用される <code>Machineset</code> と <code>Machine</code> について学びます。</p>
</div>
<hr>
<div class="sect2">
<h3 id="_machinesets_と_machines"><a class="anchor" href="#_machinesets_と_machines"></a>MachineSets と Machines</h3>
<div class="paragraph">
<p>アプリケーション管理の演習で見たように、<code>ReplicaSet</code>/<code>ReplicationController</code> とそれが作成する <code>Pod</code> の間には基本的な関係があります。同様に、<code>MachineSet</code> と`Machine` の間にも関係があります。</p>
</div>
<div class="paragraph">
<p><code>MachineSet</code> は、<code>Machine</code> オブジェクトのセットに対して希望する状態を定義します。IPIインストールを使用する場合、<code>Operator</code> の仕事は、各 <code>Machine</code> の基礎となるインスタンスが実際に存在することを確認し、最終的に各 <code>Machine</code> が <code>Node</code> になることを確認することです。</p>
</div>
<div class="paragraph">
<p>以下を実行します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machineset -n openshift-machine-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                                   DESIRED   CURRENT   READY   AVAILABLE   AGE
cluster-f4a3-lpxbs-worker-us-east-2a   1         1         1       1           47h
cluster-f4a3-lpxbs-worker-us-east-2b   1         1         1       1           47h
cluster-f4a3-lpxbs-worker-us-east-2c   1         1         1       1           47h</pre>
</div>
</div>
<div class="paragraph">
<p>OpenShiftがインストールされると、インストーラはクラウドプロバイダーに問い合わせて、利用可能なAZを得ます(この環境はAWS上にあるため)。そして、最終的に各AZの <code>MachineSet</code> を作成し、希望する <code>Machine</code> の数に達するまで、それらのセットを順番にスケーリングします。デフォルトのインストールには2つのWorkerがいるので、最初の2つのAZにはそれぞれ1つのWorkerが作られます。残りのAZは0です。</p>
</div>
<div class="paragraph">
<p>※演習で使用する環境によっては、<code>Node</code> の数が異なる場合があります。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machine -n openshift-machine-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                                         INSTANCE              STATE     TYPE         REGION      ZONE         AGE
cluster-f4a3-lpxbs-master-0                  i-04280885cafad3130   running   m4.xlarge    us-east-2   us-east-2a   47h
cluster-f4a3-lpxbs-master-1                  i-0def910edcae51d11   running   m4.xlarge    us-east-2   us-east-2b   47h
cluster-f4a3-lpxbs-master-2                  i-0beb5e40214d706fc   running   m4.xlarge    us-east-2   us-east-2c   47h
cluster-f4a3-lpxbs-worker-us-east-2a-b94pr   i-0a922c0fe765caa3c   running   m5.2xlarge   us-east-2   us-east-2a   47h
cluster-f4a3-lpxbs-worker-us-east-2b-m8gbx   i-0fb8d960b8a3a3343   running   m5.2xlarge   us-east-2   us-east-2b   47h
cluster-f4a3-lpxbs-worker-us-east-2c-5tmg7   i-0151c72cd85f85038   running   m5.2xlarge   us-east-2   us-east-2c   47h</pre>
</div>
</div>
<div class="paragraph">
<p>各 <code>Machine</code> には対応する <code>INSTANCE</code> があります。このIDに見覚えはないでしょうか?これはAWS EC2のインスタンスIDです。また、OpenShiftのMasterの <code>Machine</code> も表示されています。これらはある程度ステートフルであり、管理は別のOperatorが別のプロセスを介して処理するため、<code>MachineSet</code> の一部ではありません</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>現在、Masterの <code>Machines</code> は保護されていません。クラスタを壊す可能性があるので、誤って、または意図的に削除しないでください。修復は可能ですが、楽しいものではありません。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>最後に以下を実行します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                                         STATUS   ROLES    AGE   VERSION
ip-10-0-133-191.us-east-2.compute.internal   Ready    worker   44m   v1.16.2
ip-10-0-136-83.us-east-2.compute.internal    Ready    master   51m   v1.16.2
ip-10-0-152-132.us-east-2.compute.internal   Ready    worker   44m   v1.16.2
ip-10-0-157-139.us-east-2.compute.internal   Ready    master   51m   v1.16.2
ip-10-0-167-9.us-east-2.compute.internal     Ready    worker   44m   v1.16.2
ip-10-0-169-121.us-east-2.compute.internal   Ready    master   51m   v1.16.2</pre>
</div>
</div>
<div class="paragraph">
<p>各 <code>Machine</code> は、それぞれ <code>Node</code> に対応しています。IPIでは、Machine OperatorがEC2インスタンスを作成し、次にCoreOS内のIgnitionがOperatorから最初の命令を受け取る、bootstrapのプロセスが走ります。その結果、EC2インスタンスがOpenShift Nodeとして設定され、クラスタに参加することになります。</p>
</div>
<div class="paragraph">
<p><code>oc describe</code> で様々な <code>Machine</code> オブジェクト、<code>Node</code> オブジェクトを調べれば、どれがどれと相関しているのかが分かるでしょう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_クラスタのスケーリング"><a class="anchor" href="#_クラスタのスケーリング"></a>クラスタのスケーリング</h3>
<div class="paragraph">
<p><code>Operator</code> の「魔法」と、それを使った <code>Machine</code> と <code>Node</code> の管理のおかげで、OpenShift 4でのクラスタのスケーリングは非常に簡単に行えます。</p>
</div>
<div class="paragraph">
<p>もう一度、<code>MachineSet</code> のリストを見てみましょう。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machineset -n openshift-machine-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>そのリストの中で。<code>MachineSet`のひとつを  oc scaleコマンドでスケールしてみましょう。あなたの `MachineSet</code> の名前はラボガイドの名前とは異なる可能性があるので、特に注意してください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CLUSTERNAME=$(oc get  infrastructures.config.openshift.io cluster  -o jsonpath='{.status.infrastructureName}')
ZONENAME=$(oc get nodes -L topology.kubernetes.io/zone  --no-headers  | awk '{print $NF}' | tail -1)
oc scale machineset ${CLUSTERNAME}-worker-${ZONENAME} -n openshift-machine-api --replicas=2</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MachineSet</code> が正常にスケーリングされたというメモが表示されているはずです。次に、<code>Machine</code> のリストを見てみましょう。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machines -n openshift-machine-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>おそらく、<code>STATE</code> が <code>Pending</code> となっている <code>Machine</code> の新しいエントリがすでに存在していると思います。しばらくすると、対応するEC2インスタンスIDが表示され、以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cluster-f4a3-lpxbs-worker-us-east-2c-h7gdt   i-0b9208ec47f0e206b   running   m5.2xlarge     us-east-2   us-east-2c   47s</pre>
</div>
</div>
<div class="paragraph">
<p>この時点では、バックグラウンドでは自動的にbootstrap処理が行われています。数分後(最大で5分程度)の出力を見てみましょう。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>age</code> が非常に若いノードが見つかるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ip-10-0-166-103.us-east-2.compute.internal   Ready    worker   1m   v1.22.8</pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><code>Machine</code> が準備され、<code>Node</code> として追加されるまでには数分かかることがあります。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>続ける前に、先程スケールアップした <code>MachineSet</code> を2から1にスケールダウンしてください。</p>
</div>
<div class="paragraph">
<p>${CLUSTERNAME}と${ZONENAME}変数が、数ステップ前のスケールアップ時に設定されていることを確認してください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc scale machineset ${CLUSTERNAME}-worker-${ZONENAME} -n openshift-machine-api --replicas=1</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02_app-storage-basics.html">2. 永続ストレージ</a></span>
  <span class="next"><a href="04_infra-nodes.html">4. Infra ノードの作成</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
