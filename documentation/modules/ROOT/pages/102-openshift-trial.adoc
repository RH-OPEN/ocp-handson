= OpenShiftの体験
:navtitle: openshift-trial
include::_attributes.adoc[]


== 演習の概要
このモジュールでは、OpenShiftを利用して、簡単なWebサーバをデプロイします。

---

=== OpenShift環境へのログインとアプリケーション作成

前の演習では、Podmanを利用した簡単なWebサーバをデプロイしました。本演習ではOpenShiftを利用して同様のことを実施してみます。
OpenShiftのWebコンソールにアクセスして、ログインします。

NOTE: 本演習を自習していない場合、OpenShiftのWebコンソールURLとアカウント情報はインストラクターから案内されます。

image::podman/login.png[]

最初にアプリケーションの開発やデプロイ場所となる「プロジェクト」を作成する必要があります。
OpenShiftでは「プロジェクト」単位でアプリケーションなどのリソースを分離する、
マルチテナンシー的な利用方法がデフォルトで可能になっています。

「新規プロジェクトを作成します」をクリックして、適当なプロジェクト名(この例では、test-project99)を入力して「作成」をクリックします。
複数人でOpenShiftクラスターを共有している場合、プロジェクト名の重複はできませんので、被らないような名前を付けてください。

image::podman/project-create.png[]

プロジェクトの作成が完了すると、OpenShiftに標準で用意されているサンプルのテンプレートを利用して、
アプリケーションを作成するためのスタートアップリソースが表示されます。

image::podman/startup-resource.png[]

今回はこれらのリソースを利用せずに、既存のGitHubのサンプルPHPコードを利用して、Webアプリケーションをデプロイしてみます。
コンソール右上にある「+」アイコンをクリックして、「Gitからのインポート」を選択します。

image::podman/git-import01.png[]

続いて、下記のテキストフィールドに以下を入力します。
「検証済み」の表示を確認したら、「作成」ボタンをクリックします。
これだけでサンプルアプリケーションのデプロイが完了します。

- GitリポジトリーURL: `https://github.com/h-kojima/php-hello-world`

image::podman/git-import02.png[]

[Note]
====
OpenShiftではGitリポジトリのソースコードURLを指定すると、JavaやPHPなどの主要言語であれば、
OpenShiftに標準で備わっている専用コンテナを利用して、ユーザーアプリのコンテナイメージを自動作成してくれます。
====

しばらく待つと、「php-hello-world-git-app」という名前のアプリケーションが作成されたことが、
トポロジー画面から確認できます。

image::podman/topology01.png[]

トポロジー画面の「php」アイコンをクリックして、「リソース」タブの「Routes」にあるURLから、
PHPのサンプルWebアプリケーションにアクセスできます。アクセスすると、以下のようなメッセージが確認できます。

```
Hello Podman 2025-12-25

Host Name: php-hello-world-6db8695b55-q24wl
Host IP: 10.128.0.236
```

[Note]
====
ここで表示されているIPアドレスは、OpenShift上のコンテナ(
https://kubernetes.io/ja/docs/concepts/workloads/pods/[Kubernetes Pod])に、動的に割り当てられたIPアドレスとなります。
OpenShiftでは、コンテナ間通信を行うためのネットワークが自動的に作成されて利用されます。
====

トポロジー画面右にある「ログの表示」をクリックすると、「php-hello-wold」コンテナを作成した時のログを確認できます。
Podmanの演習の時に確認できた、Containerfileからのカスタムイメージ作成のようなログなどを確認できます。

image::podman/build-log.png[]


=== OpenShiftでのアプリケーション更改

NOTE: この演習は、ユーザーが利用可能なGitリポジトリが無い場合は実施できません。

Gitリポジトリのソースコードを修正してコミットした場合、
コンテナイメージを再びルドすることで、コミットしたソースコードが反映されたアプリケーションをデプロイできます。
この時は、トポロジー画面の対象のアプリケーションの「ビルドの開始」ボタンをクリックします。

image::podman/topology02.png[]

[Note]
====
OpenShiftが持っているコンテナリポジトリに前回のビルドで保存されたコンテナイメージによる
インクリメンタルビルド(増分ビルド)を行うことで、前回から変更があったファイルだけがビルド対象となり、
ビルドを効率的に実施しています。
====

再び「リソース」タブの「Routes」にあるURLから、PHPのサンプルWebアプリケーションにアクセスすると、
次の例のような変更後のメッセージ出力を確認できます。
この時、イメージの再ビルドに伴ってコンテナも再起動されているので、コンテナのIPアドレスも変更されています。

```
Hello Podman 2025-12-25 Changed

Host Name: php-hello-world-6f678646-jvwc7
Host IP: 10.128.0.253
```